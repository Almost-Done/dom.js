<html>
    <head>
        <title>Servo WebWorkers</title>
        <style type="text/css">
body {
    padding: 1em;
}

div {
    padding: 0.5em; margin: 0px; border: 1px solid black;
}

.element {
    display: block;
    padding: 0.5em;
}

.node-id {
    padding-right: 1em;
    color: #cccccc;
    cursor: pointer;
}

.collapsed:after {
    content: "...";
}

.hidden {
    display: none;
}
        </style>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.6.4.min.js">
        </script>
        <script type="text/javascript; version=1.8">
var worker = new Worker('servo-worker.js');
var depths = {1: 0};
var colors = {
    html: 'green',
    head: 'maroon',
    title: 'red',
    style: 'purple',
    script: 'blueviolet',
    body: 'orange',
    div: 'blue',
    span: 'darkgreen'
};

var previous = null;

worker.onmessage = function(event) {
    var append = true;
    var evt = JSON.parse(event.data);

    if (evt === "complete") {
        console.log("complete");
        $('.node-id').click(
            function() {
                var self = $(this);
                if (self.hasClass('collapsed')) {
                    self.removeClass('collapsed');
                    self.nextAll().removeClass('hidden');
                } else {
                    self.addClass('collapsed');
                    self.nextAll().addClass('hidden');
                }
                console.log('click');
            }
        );


        return;
    }

    if (evt.nid === undefined) {
        evt.nid = -1;
    }
    if (evt.parent !== undefined) {
        depths[evt.nid] = depths[evt.parent] + 1;
    } else {
        return;
    }

    var child = document.createElement('span');
    child.setAttribute('id', evt.nid);
    var node = document.createElement('span');
    child.setAttribute('style', 'margin-left: 0.5em; ');
    var nodeId = document.createElement('span');
    nodeId.setAttribute('class', 'node-id');
    nodeId.appendChild(document.createTextNode(evt.nid));
    child.appendChild(nodeId);
    child.appendChild(node);

    function out() {
        var output = '';
        for (var i = 0; i < arguments.length; i++) {
            output += arguments[i].toString() + ' ';
        }
        node.appendChild(document.createTextNode(output));
    }

    var domjsNodeStr = evt.child;
    if (domjsNodeStr === undefined) {
        return;
    }

    var NULL = '\0';

    switch (domjsNodeStr.charAt(0)) {
      case 'T':
        var val = domjsNodeStr.substr(1).split(NULL)[0];
        nodeId.setAttribute('title', JSON.stringify(val));
        // don't show whitespace-only text nodes.
        if (!val.match(/^\s+$/)) {
            node.setAttribute('style',
                'white-space: pre; font-family: monospace; margin: 0.5em; ');
            out(val.trim());
        } else {
            append = false;
            previous.appendChild(child);
        }
        break;
      case 'C':
        out("Comment node", JSON.stringify(
            domjsNodeStr.substr(1).split(NULL)[0])
        );
        break;
      case 'H':
          // html node
      case 'E':
        var spl = domjsNodeStr.substr(1).split(NULL);
        //out(JSON.stringify(domjsNodeStr));
        var attrstr = spl[1];
        var l = attrstr.charCodeAt(0);
        if (l === 0xFFFF) l = parseInt(attrstr.charCodeAt(1));
        // todo print out attributes

        if (l === l) { // if l is not NaN
            var attributes = {}
            var attrstr = domjsNodeStr.substr(domjsNodeStr.indexOf(NULL) + 2);
            var attrsplit = attrstr.split(NULL);
            for (var i = 0; i < attrsplit.length / 2; i += 2) {
                var attrname = attrsplit[i].substr(1)
                attributes[attrname] = attrsplit[i + 1];
            }
            out("<", spl[0], JSON.stringify(attributes), ">");
        } else {
            out("<", spl[0], ">");
        }
        child.setAttribute('class', 'element');

        if (colors[spl[0]] !== undefined) {
            child.setAttribute('style', 'color: ' + colors[spl[0]]);
        }

        break;
    case 'D':
        var spl = domjsNodeStr.substr(1).split(NULL);
        out("Document node", JSON.stringify(spl[0]));
        break;
      default:
        throw new Error('Unhandled case of stringified node: ' + domjsNodeStr.charAt(0));
    }
    if (append) {
        if (evt['parent'] !== undefined) {
            var parent = document.getElementById(evt.parent);
            if (parent) {
                parent.appendChild(child);
            } else {
                document.body.appendChild(child);
            }
        } else {
            document.body.appendChild(child);
        }
    }
    previous = child;
}


function GET(url) {
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
        if (this.readyState === 4) {
            worker.postMessage({url: url, body: this.responseText});
        }
    }
    xhr.open('GET', url);
    xhr.send();
}

GET("foo.html");

        </script>
    </head>
    <body>
        <h1>Servo WebWorkers</h1>
    </body>
</html>